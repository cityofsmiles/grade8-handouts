<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 8 Math Handouts</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const ChevronLeft = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>);
        const ChevronRight = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>);
        const Menu = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>);
        const X = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const Loader = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>);
        const Share = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>);

        const MathHandoutsApp = () => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [menuOpen, setMenuOpen] = useState(false);
            const [handouts, setHandouts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedQuarter, setSelectedQuarter] = useState(null); 
            const [showCopyNotif, setShowCopyNotif] = useState(false);
            
            const isInitialMount = useRef(true);

            const BASE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKokexxJE7NAJWhovLtTQHszKtFAgTZ7Cw-IczbSU-1mrOnYEtJxtSkpI5mGQ9-wAUeU1j8_0Pes2W/pub";
            const quarters = ['1st', '2nd', '3rd', '4th'];

            const createSlug = (title) => {
                return title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            };

            const parseURL = () => {
                const hash = window.location.hash.slice(1);
                if (hash) {
                    const match = hash.match(/^(\d[a-z]{2})-(\d+)-/);
                    if (match) {
                        return { quarter: match[1], index: parseInt(match[2]) };
                    }
                }
                return null;
            };

            const updateURL = (quarter, index) => {
                if (handouts[index]) {
                    const slug = createSlug(handouts[index].title);
                    const newHash = `#${quarter}-${index}-${slug}`;
                    if (window.location.hash !== newHash) {
                        window.history.replaceState(null, null, newHash);
                    }
                }
            };

            useEffect(() => {
                const urlData = parseURL();
                const initialQuarter = (urlData && quarters.includes(urlData.quarter)) ? urlData.quarter : '1st';
                setSelectedQuarter(initialQuarter);
                fetchHandouts(initialQuarter, urlData);

                const handleHashChange = () => {
                    const data = parseURL();
                    if (data) {
                        if (data.quarter !== selectedQuarter) setSelectedQuarter(data.quarter);
                        else setCurrentIndex(data.index);
                    }
                };

                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            useEffect(() => {
                if (isInitialMount.current) isInitialMount.current = false;
                else if (selectedQuarter) fetchHandouts(selectedQuarter);
            }, [selectedQuarter]);

            useEffect(() => {
                if (handouts.length > 0 && !loading && selectedQuarter) {
                    updateURL(selectedQuarter, currentIndex);
                }
            }, [currentIndex, selectedQuarter, handouts, loading]);

            const fetchHandouts = async (quarter, urlData = null) => {
                try {
                    setLoading(true);
                    setError(null);
                    const sheetUrl = `${BASE_SHEET_URL}?gid=${getGidForQuarter(quarter)}&single=true&output=csv`;
                    
                    const response = await fetch(sheetUrl);
                    if (!response.ok) throw new Error("Could not connect to the data source.");
                    
                    const csvText = await response.text();
                    const rows = csvText.split('\n').filter(row => row.trim());
                    const data = [];
                    
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i].trim();
                        // Regex to handle potential quotes in CSV
                        const match = row.match(/^"([^"]*)","([^"]*)"$/) || row.match(/^([^,]*),(.*)$/);
                        if (match) {
                            const title = match[1].trim();
                            const rawUrls = match[2].trim();
                            // Split by comma to handle multiple photos
                            const imageUrls = rawUrls.split(',').map(url => url.trim().replace(/^"|"$/g, ''));
                            
                            data.push({ title, imageUrls });
                        }
                    }
                    
                    setHandouts(data);
                    const targetData = urlData || parseURL();
                    if (targetData && targetData.quarter === quarter && targetData.index < data.length) {
                        setCurrentIndex(targetData.index);
                    } else {
                        setCurrentIndex(0);
                    }
                    setLoading(false);
                } catch (err) {
                    setError("Failed to load handouts. Please check your internet connection.");
                    setLoading(false);
                }
            };

            const getGidForQuarter = (q) => {
                const gidMap = { '1st': '1537771396', '2nd': '341159409', '3rd': '1458047145', '4th': '0' };
                return gidMap[q];
            };

            const changeQuarter = (q) => {
                if (q !== selectedQuarter) {
                    setMenuOpen(false);
                    setSelectedQuarter(q);
                }
            };

            const copyCurrentURL = () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    setShowCopyNotif(true);
                    setTimeout(() => setShowCopyNotif(false), 2000);
                });
            };

            if (loading || !selectedQuarter) {
                return (
                    <div className="min-h-screen bg-indigo-50 flex items-center justify-center">
                        <Loader size={48} className="animate-spin text-indigo-600" />
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-900">
                    {showCopyNotif && (
                        <div className="fixed top-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-fade-in font-bold">
                            Link copied to clipboard!
                        </div>
                    )}

                    <header className="bg-indigo-600 text-white shadow-lg sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <h1 className="text-xl md:text-2xl font-black tracking-tight">Grade 8 Math Handouts</h1>
                            <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-indigo-700 rounded-lg lg:hidden transition-colors">
                                {menuOpen ? <X size={24} /> : <Menu size={24} />}
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        {/* Sidebar */}
                        <aside className={`${menuOpen ? 'translate-x-0' : '-translate-x-full'} fixed lg:relative lg:translate-x-0 z-20 w-80 bg-white border-r border-slate-200 shadow-xl lg:shadow-none transition-transform duration-300 h-full overflow-y-auto`}>
                            <div className="p-5">
                                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Quarters</h2>
                                <div className="grid grid-cols-2 gap-2 mb-8">
                                    {quarters.map((q) => (
                                        <button key={q} onClick={() => changeQuarter(q)} className={`py-2 px-3 rounded-lg font-bold text-sm transition-all ${selectedQuarter === q ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                            {q}
                                        </button>
                                    ))}
                                </div>
                                
                                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Lessons</h2>
                                <nav className="space-y-1">
                                    {handouts.map((h, i) => (
                                        <button key={i} onClick={() => { setCurrentIndex(i); setMenuOpen(false); }} className={`w-full text-left p-3 rounded-xl text-sm transition-all ${currentIndex === i ? 'bg-indigo-50 text-indigo-700 font-bold border-l-4 border-indigo-600' : 'hover:bg-slate-50 text-slate-600'}`}>
                                            {h.title}
                                        </button>
                                    ))}
                                </nav>
                            </div>
                        </aside>

                        {/* Main Content */}
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50">
                            <div className="max-w-3xl mx-auto">
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div>
                                        <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter">{selectedQuarter} Quarter</span>
                                        <h2 className="text-xl md:text-2xl font-extrabold text-slate-800 mt-1">{handouts[currentIndex]?.title}</h2>
                                    </div>
                                    <button onClick={copyCurrentURL} className="flex items-center gap-2 text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-xl transition-all font-bold text-sm border border-indigo-100">
                                        <Share size={18} /> Share Link
                                    </button>
                                </div>

                                {/* Multi-Image Rendering */}
                                <div className="space-y-4 mb-8">
                                    {handouts[currentIndex]?.imageUrls.map((url, idx) => (
                                        <div key={idx} className="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                                            <img 
                                                src={url} 
                                                alt={`${handouts[currentIndex]?.title} - Part ${idx + 1}`} 
                                                className="w-full h-auto block" 
                                                loading="lazy"
                                            />
                                        </div>
                                    ))}
                                </div>

                                {/* Controls */}
                                <div className="flex items-center justify-between bg-white rounded-2xl shadow-lg border border-slate-200 p-4 sticky bottom-0">
                                    <button 
                                        onClick={() => currentIndex > 0 && setCurrentIndex(currentIndex - 1)} 
                                        disabled={currentIndex === 0} 
                                        className="flex items-center gap-2 px-4 md:px-6 py-3 rounded-xl font-bold bg-indigo-600 text-white disabled:bg-slate-100 disabled:text-slate-400 transition-all active:scale-95"
                                    >
                                        <ChevronLeft size={20} /> <span className="hidden md:inline">Previous</span>
                                    </button>
                                    
                                    <span className="text-slate-500 font-bold tabular-nums">
                                        {currentIndex + 1} <span className="text-slate-300 mx-1">/</span> {handouts.length}
                                    </span>

                                    <button 
                                        onClick={() => currentIndex < handouts.length - 1 && setCurrentIndex(currentIndex + 1)} 
                                        disabled={currentIndex === handouts.length - 1} 
                                        className="flex items-center gap-2 px-4 md:px-6 py-3 rounded-xl font-bold bg-indigo-600 text-white disabled:bg-slate-100 disabled:text-slate-400 transition-all active:scale-95"
                                    >
                                        <span className="hidden md:inline">Next</span> <ChevronRight size={20} />
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>

                    {menuOpen && <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-10 lg:hidden" onClick={() => setMenuOpen(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MathHandoutsApp />);
    </script>
</body>
</html>
